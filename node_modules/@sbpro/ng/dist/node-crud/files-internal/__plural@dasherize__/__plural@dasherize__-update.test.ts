import httpCodes from '@inip/http-codes';
import { mockFind<%= classify(name) %> } from '@mocks/@app/routes/_shared';
import {
    mockFastifyInstanceParameter,
    MockFastifyReply,
    mockGenerateError,
    mockReply,
    mockRoute,
    requestMockWithParams,
} from '@mocks/fastify';
import { mockSave } from '@mocks/typeorm';
import {
    TestResults<%= classify(name) %>,
    TestUpdate<%= classify(name) %>Params,
    TestUpdate<%= classify(name) %>Payload,
    Update<%= classify(name) %>Params,
    Update<%= classify(name) %>Payload,
} from '@start-bootstrap/website-shared-types';
import { Test<%= classify(name) %> } from '@testing/objects';
import { FastifyRequest } from 'fastify';

import { handler, <%= camelize(plural) %>Update } from './<%= dasherize(plural) %>-update';

describe('<%= classify(plural) %>Update', () => {
    beforeEach(() => {
        mockFind<%= classify(name) %>.mockReset();
        mockGenerateError.mockReset();
        (requestMockWithParams as FastifyRequest<{
            Params: Update<%= classify(name) %>Params;
            Body: Update<%= classify(name) %>Payload;
        }>).params = new TestUpdate<%= classify(name) %>Params();
        (requestMockWithParams as FastifyRequest<{
            Params: Update<%= classify(name) %>Params;
            Body: Update<%= classify(name) %>Payload;
        }>).body = new TestUpdate<%= classify(name) %>Payload();
    });

    it('should create the <%= camelize(plural) %>Update route', async () => {
        <%= camelize(plural) %>Update(mockFastifyInstanceParameter, {}, () => {});
        expect(mockRoute).toHaveBeenCalled();
    });
    it('should update the <%= camelize(name) %>', async () => {
        mockFind<%= classify(name) %>.mockImplementation(() => new Test<%= classify(name) %>());
        const returnValue = await handler.call(
            mockFastifyInstanceParameter,
            requestMockWithParams as FastifyRequest<{
                Params: Update<%= classify(name) %>Params;
                Body: Update<%= classify(name) %>Payload;
            }>,
            mockReply as MockFastifyReply<{
                Params: Update<%= classify(name) %>Params;
                Body: Update<%= classify(name) %>Payload;
            }>
        );
        expect(mockFind<%= classify(name) %>).toHaveBeenCalled();
        expect(returnValue).toEqual(new TestResults<%= classify(name) %>());
    });
    it('should catch errors when trying to update <%= camelize(name) %>', async () => {
        const thrownError = new Error('TEST_ERROR');
        mockFind<%= classify(name) %>.mockImplementation(() => new Test<%= classify(name) %>());
        mockSave.mockImplementation(() => {
            throw thrownError;
        });
        try {
            const returnValue = await handler.call(
                mockFastifyInstanceParameter,
                requestMockWithParams as FastifyRequest<{
                    Params: Update<%= classify(name) %>Params;
                    Body: Update<%= classify(name) %>Payload;
                }>,
                mockReply as MockFastifyReply<{
                    Params: Update<%= classify(name) %>Params;
                    Body: Update<%= classify(name) %>Payload;
                }>
            );
        } catch (error) {
            expect(mockGenerateError).toHaveBeenLastCalledWith(
                httpCodes.INTERNAL_SERVER_ERROR,
                'ERROR_UPDATING_<%= constantCase(name) %>',
                thrownError
            );
        }
    });
});
